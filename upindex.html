<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Agri Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>

    <style>
        body, html { margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        
        /* ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá‡¶∞ ‡¶¨‡ßç‡¶Ø‡¶æ‡¶ï‡¶ó‡ßç‡¶∞‡¶æ‡¶â‡¶®‡ßç‡¶° ‡¶∏‡¶æ‡¶¶‡¶æ */
        #map { height: 100vh; width: 100%; z-index: 1; background: #ffffff; }

        /* ‡¶¨‡¶æ‡¶ü‡¶® ‡¶ì ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        #dashboard-btn { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; cursor: pointer; text-decoration: none; color: #333; display: flex; align-items: center; gap: 5px; }
        #logout-btn { position: absolute; top: 20px; right: 60px; background: #ff5252; color: white; padding: 10px 15px; border-radius: 8px; z-index: 2000; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; cursor: pointer; text-decoration: none; display: none; align-items: center; gap: 5px; font-size: 14px; }
        #back-btn { position: absolute; top: 20px; left: 20px; background: white; padding: 10px 15px; border-radius: 8px; z-index: 2001; box-shadow: 0 2px 10px rgba(0,0,0,0.2); font-weight: bold; cursor: pointer; display: none; text-decoration: none; color: #333; align-items: center; gap: 5px; }

        #start-btn-container { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 1000; width: 80%; display: flex; justify-content: center; }
        .btn-start { background: #4CAF50; color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; display: flex; align-items: center; gap: 10px; width: 100%; justify-content: center; }
        
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 1000; display: none; }
        .btn-action { background: white; border: none; padding: 15px 20px; border-radius: 50px; font-size: 18px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.3); display: flex; align-items: center; gap: 10px; cursor: pointer; }
        .btn-add { background: #39FF14; color: #000; } .btn-undo { background: #fff; color: #ff5252; } .btn-done { background: #2196F3; color: white; display: none; }
        
        .gps-btn { position: absolute; bottom: 130px; right: 20px; background: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; color: #333; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 1000; cursor: pointer; }
        .crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none; display: none; }
        .crosshair i { font-size: 40px; color: #fff; text-shadow: 0 0 5px #000; }
        .info-top { position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); color: white; padding: 8px 20px; border-radius: 20px; z-index: 1000; font-size: 14px; white-space: nowrap; display: none; }
        
        #form-box { position: absolute; bottom: 0; left: 0; width: 100%; background: white; padding: 25px; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 20px rgba(0,0,0,0.2); z-index: 2000; transition: transform 0.3s ease; transform: translateY(100%); max-height: 85vh; overflow-y: auto; }
        #form-box.active { transform: translateY(0); }
        
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .submit-btn { width: 100%; background: #4CAF50; color: white; padding: 15px; border: none; border-radius: 10px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .cancel-btn { background: transparent; color: #777; width: 100%; padding: 10px; border: none; margin-top: 5px; }
        
        #scanner-line { position: absolute; top: 0; left: 0; width: 100%; height: 5px; background: #39FF14; box-shadow: 0 0 15px #39FF14; z-index: 1500; display: none; animation: scanMove 2s infinite linear; }
        @keyframes scanMove { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        #scan-btn { width: 100%; background: linear-gradient(45deg, #2196F3, #21CBF3); color: white; padding: 15px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 15px; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 16px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3); }
        #analysis-result { background: #e3f2fd; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 5px solid #2196F3; display: none; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* ‡¶Æ‡¶°‡¶æ‡¶≤ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); display: none; justify-content: center; align-items: center; z-index: 5000; }
        .modal-box { background: white; padding: 25px; width: 90%; max-width: 350px; border-radius: 15px; position: relative; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 20px; cursor: pointer; color: #aaa; }
        .auth-input { background: #f9f9f9; }
        .auth-btn { width: 100%; padding: 12px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .toggle-link { margin-top: 15px; font-size: 13px; color: #555; }
        .toggle-link span { color: #2196F3; font-weight: bold; cursor: pointer; }
        .hidden { display: none; }

        .leaflet-control-geocoder { border: none !important; border-radius: 8px !important; box-shadow: 0 4px 10px rgba(0,0,0,0.2) !important; margin-top: 10px !important; margin-left: 10px !important; }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="scanner-line"></div>

    <a id="dashboard-btn" href="Dashboard.html"><i class="fas fa-list"></i> ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶≤‡¶ø‡¶∏‡ßç‡¶ü</a>
    <div id="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></div>
    <a id="back-btn" href="Dashboard.html"><i class="fas fa-arrow-left"></i> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</a>

    <div class="crosshair" id="crosshair-icon"><i class="fas fa-plus-circle"></i></div>
    <div class="gps-btn" onclick="locateUser()"><i class="fas fa-crosshairs"></i></div>
    <div class="info-top" id="msg-box">‡¶ü‡¶æ‡¶∞‡ßç‡¶ó‡ßá‡¶ü‡¶ü‡¶ø ‡¶ú‡¶Æ‡¶ø‡¶∞ ‡¶ï‡ßã‡¶£‡¶æ‡ßü ‡¶®‡¶ø‡¶®</div>

    <div id="start-btn-container">
        <button class="btn-start" onclick="startMappingMode()">
            <i class="fas fa-draw-polygon"></i> ‡¶ú‡¶Æ‡¶ø ‡¶Æ‡¶æ‡¶™‡¶æ ‡¶∂‡ßÅ‡¶∞‡ßÅ ‡¶ï‡¶∞‡ßÅ‡¶®
        </button>
    </div>

    <div class="controls" id="control-bar">
        <button class="btn-action btn-undo" onclick="undoPoint()"><i class="fas fa-undo"></i></button>
        <button class="btn-action btn-add" onclick="addPoint()"><i class="fas fa-map-pin"></i> ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü</button>
        <button class="btn-action btn-done" id="done-btn" onclick="finishDrawing()"><i class="fas fa-check"></i> ‡¶∂‡ßá‡¶∑</button>
    </div>

    <div id="form-box">
        <h2 style="margin:0 0 5px 0; color:#4CAF50;">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶´‡¶∞‡ßç‡¶Æ</h2>
        <p style="font-size: 14px; color:#555;">‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <strong id="display-name" style="color:#2E7D32">Guest</strong>!</p>
        <p style="font-size: 16px; margin-bottom: 10px;">‡¶ú‡¶Æ‡¶ø‡¶∞ ‡¶Æ‡¶æ‡¶™: <strong id="area-val" style="color:#2196F3">0</strong> ‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</p>
        
        <label style="font-weight:bold; color:#555; margin-top:10px; display:block;">‡¶ï‡¶ø ‡¶∏‡ßá‡¶¨‡¶æ ‡¶®‡¶ø‡¶§‡ßá ‡¶ö‡¶æ‡¶®?</label>
        <select id="serviceType" style="background:#f9f9f9;">
            <option value="Land Measurement">‡¶∂‡ßÅ‡¶ß‡ßÅ‡¶Æ‡¶æ‡¶§‡ßç‡¶∞ ‡¶ú‡¶Æ‡¶ø ‡¶Æ‡¶æ‡¶™‡¶æ</option>
            <option value="Soil Testing">‡¶Æ‡¶æ‡¶ü‡¶ø ‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ (Satellite)</option>
            <option value="Drone Spraying">‡¶°‡ßç‡¶∞‡ßã‡¶® ‡¶¶‡¶ø‡ßü‡ßá ‡¶∏‡ßç‡¶™‡ßç‡¶∞‡ßá</option>
            <option value="Auto Harvesting">‡¶∞‡ßã‡¶¨‡¶ü ‡¶¶‡¶ø‡ßü‡ßá ‡¶´‡¶∏‡¶≤ ‡¶ï‡¶æ‡¶ü‡¶æ</option>
        </select>

        <button id="scan-btn" onclick="scanLand()"><i class="fas fa-satellite-dish"></i> ‡¶∏‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶≤‡¶æ‡¶á‡¶ü ‡¶ö‡ßá‡¶ï (Optional)</button>
        <div id="analysis-result">
            <div style="font-weight:bold; color:#1565C0;">üì° ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü:</div>
            <span id="scan-status">...</span>
        </div>

        <button class="submit-btn" onclick="checkAuthAndSave()">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        <button class="cancel-btn" onclick="resetMap()">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
    </div>

    <div class="modal-overlay" id="auth-modal">
        <div class="modal-box">
            <span class="close-btn" onclick="closeLoginModal()">&times;</span>
            <div id="login-view">
                <h2 style="color:#4CAF50; margin-bottom:5px;">‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶§‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</h2>
                <input type="tel" id="in-login-phone" class="auth-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
                <button class="auth-btn" onclick="inAppLogin()">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <div class="toggle-link">‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á? <span onclick="switchView('register')">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></div>
            </div>
            <div id="register-view" class="hidden">
                <h2 style="color:#2196F3; margin-bottom:5px;">‡¶®‡¶§‡ßÅ‡¶® ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü</h2>
                <input type="text" id="in-reg-name" class="auth-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶®‡¶æ‡¶Æ">
                <input type="tel" id="in-reg-phone" class="auth-input" placeholder="‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞">
                <button class="auth-btn" style="background:#2196F3;" onclick="inAppRegister()">‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</button>
                <div class="toggle-link">‡¶Ü‡¶ó‡ßá‡¶á ‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶Ü‡¶õ‡ßá? <span onclick="switchView('login')">‡¶≤‡¶ó‡¶á‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®</span></div>
            </div>
        </div>
    </div>

    <script>
        var map;
        var points = []; 
        var markers = []; 
        var polygonLayer = null; 
        var finalArea = 0; 
        var aiSuggestion = "";
        var scriptURL = "https://script.google.com/macros/s/AKfycbxPRbeqGFU_W-Ucx-www7Fn2v_6Q03wJ0IW_EUZvFmqYUBCf-N4OuzkHs_5vNSivrfg/exec"; 

        // --- ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® ---
        function updateUI() {
            var userName = localStorage.getItem('user_name');
            if(userName) {
                document.getElementById('display-name').innerText = userName;
                document.getElementById('logout-btn').style.display = 'flex';
            } else {
                document.getElementById('display-name').innerText = "Guest";
                document.getElementById('logout-btn').style.display = 'none';
            }
        }

        function startMappingMode() {
            document.getElementById('start-btn-container').style.display = 'none';
            document.getElementById('control-bar').style.display = 'flex';
            document.getElementById('crosshair-icon').style.display = 'block';
            document.getElementById('msg-box').style.display = 'block';
        }

        function addPoint() {
            if(!map) return;
            var center = map.getCenter(); 
            points.push([center.lat, center.lng]);
            var marker = L.circleMarker([center.lat, center.lng], { color: 'white', fillColor: '#39FF14', fillOpacity: 1, radius: 5 }).addTo(map);
            markers.push(marker); 
            drawPolygon();
            if(points.length >= 3) { document.getElementById('done-btn').style.display = 'flex'; document.getElementById('msg-box').innerText = "‡¶™‡¶∞‡ßá‡¶∞ ‡¶ï‡ßã‡¶£‡¶æ‡ßü ‡¶Ø‡¶æ‡¶® ‡¶¨‡¶æ ‡¶∂‡ßá‡¶∑ ‡¶ö‡¶æ‡¶™‡ßÅ‡¶®"; }
        }

        function drawPolygon() { 
            if (polygonLayer) map.removeLayer(polygonLayer); 
            if (points.length > 0) { polygonLayer = L.polygon(points, { color: '#39FF14', weight: 3, fillColor: '#39FF14', fillOpacity: 0.3 }).addTo(map); } 
        }

        function undoPoint() { 
            if(points.length > 0) { 
                points.pop(); 
                map.removeLayer(markers.pop()); 
                drawPolygon(); 
                if(points.length < 3) document.getElementById('done-btn').style.display = 'none'; 
            } 
        }

        function finishDrawing() {
            var turfPoints = [...points, points[0]]; 
            var geoJsonPoints = turfPoints.map(p => [p[1], p[0]]); 
            var polygon = turf.polygon([geoJsonPoints]);
            var areaSqMeters = turf.area(polygon); 
            finalArea = (areaSqMeters / 40.4686).toFixed(2);
            map.fitBounds(polygonLayer.getBounds(), {padding: [50, 50]});
            document.getElementById('area-val').innerText = finalArea;
            document.getElementById('form-box').classList.add('active');
            document.getElementById('control-bar').style.display = 'none';
            document.getElementById('crosshair-icon').style.display = 'none';
            document.getElementById('msg-box').style.display = 'none';
        }

        function resetMap() {
            points = []; markers.forEach(m => map.removeLayer(m)); markers = []; if(polygonLayer) map.removeLayer(polygonLayer);
            document.getElementById('form-box').classList.remove('active');
            document.getElementById('start-btn-container').style.display = 'flex';
            document.getElementById('control-bar').style.display = 'none';
            document.getElementById('crosshair-icon').style.display = 'none';
            document.getElementById('done-btn').style.display = 'none';
            document.getElementById('msg-box').style.display = 'none';
            document.getElementById('analysis-result').style.display = 'none';
            document.getElementById('scan-btn').innerText = "‡¶∏‡ßç‡¶Ø‡¶æ‡¶ü‡ßá‡¶≤‡¶æ‡¶á‡¶ü ‡¶ö‡ßá‡¶ï"; document.getElementById('scan-btn').disabled = false;
        }

        function scanLand() {
            var scanner = document.getElementById('scanner-line'); var btn = document.getElementById('scan-btn'); var resultBox = document.getElementById('analysis-result'); var status = document.getElementById('scan-status');
            scanner.style.display = 'block'; btn.disabled = true; btn.innerText = "‡¶∏‡ßç‡¶ï‡ßç‡¶Ø‡¶æ‡¶® ‡¶ö‡¶≤‡¶õ‡ßá..."; resultBox.style.display = 'none';
            setTimeout(function() {
                scanner.style.display = 'none'; btn.innerText = "‚úî ‡¶Ö‡ßç‡¶Ø‡¶æ‡¶®‡¶æ‡¶≤‡¶æ‡¶á‡¶∏‡¶ø‡¶∏ ‡¶∏‡¶Æ‡ßç‡¶™‡¶®‡ßç‡¶®"; resultBox.style.display = 'block';
                var center = map.getCenter(); var lat = center.lat; var soilType = "‡¶¶‡ßã‡¶Ü‡¶Å‡¶∂ ‡¶Æ‡¶æ‡¶ü‡¶ø"; var crop = "‡¶Ü‡¶≤‡ßÅ, ‡¶ó‡¶Æ";
                if(lat > 24) { soilType = "‡¶¨‡ßá‡¶≤‡ßá-‡¶¶‡ßã‡¶Å‡¶Ü‡¶∂"; crop = "‡¶≠‡ßÅ‡¶ü‡ßç‡¶ü‡¶æ, ‡¶¨‡¶æ‡¶¶‡¶æ‡¶Æ"; } else if (lat < 23) { soilType = "‡¶≤‡¶¨‡¶£‡¶æ‡¶ï‡ßç‡¶§ ‡¶Æ‡¶æ‡¶ü‡¶ø"; crop = "‡¶®‡¶æ‡¶∞‡¶ï‡ßá‡¶≤"; }
                aiSuggestion = "‡¶Æ‡¶æ‡¶ü‡¶ø: " + soilType + "‡•§ ‡¶´‡¶∏‡¶≤: " + crop; status.innerHTML = "<strong>‡¶Æ‡¶æ‡¶ü‡¶ø:</strong> " + soilType + "<br><strong>‡¶™‡¶∞‡¶æ‡¶Æ‡¶∞‡ßç‡¶∂:</strong> " + crop;
            }, 3000);
        }

        function locateUser() { 
            var btn = document.querySelector('.gps-btn'); 
            btn.style.background = '#ddd'; 
            map.locate({ setView: true, maxZoom: 18, enableHighAccuracy: true, timeout: 8000 }); 
        }

        function logout() {
            if(confirm("‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) {
                localStorage.removeItem('user_phone');
                localStorage.removeItem('user_name');
                updateUI();
                window.location.href = 'login.html';
            }
        }

        function checkAuthAndSave() {
            var phone = localStorage.getItem('user_phone');
            if(phone) { saveData(phone, localStorage.getItem('user_name')); } 
            else { document.getElementById('auth-modal').style.display = 'flex'; }
        }
        function closeLoginModal() { document.getElementById('auth-modal').style.display = 'none'; }
        function switchView(view) {
            if(view === 'register') { document.getElementById('login-view').classList.add('hidden'); document.getElementById('register-view').classList.remove('hidden'); }
            else { document.getElementById('register-view').classList.add('hidden'); document.getElementById('login-view').classList.remove('hidden'); }
        }
        function inAppLogin() {
            var phone = document.getElementById('in-login-phone').value.trim();
            if(!phone) { alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®!"); return; }
            fetch(scriptURL).then(res => res.json()).then(data => {
                var user = data.find(item => item.phone == phone || "0"+item.phone == phone);
                if(user) { localStorage.setItem('user_name', user.name); localStorage.setItem('user_phone', user.phone); updateUI(); closeLoginModal(); saveData(user.phone, user.name); }
                else { alert("‡¶è‡¶ï‡¶æ‡¶â‡¶®‡ßç‡¶ü ‡¶®‡ßá‡¶á! ‡¶∞‡ßá‡¶ú‡¶ø‡¶∏‡ßç‡¶ü‡ßç‡¶∞‡ßá‡¶∂‡¶® ‡¶ï‡¶∞‡ßÅ‡¶®‡•§"); switchView('register'); document.getElementById('in-reg-phone').value = phone; }
            });
        }
        function inAppRegister() {
            var name = document.getElementById('in-reg-name').value; var phone = document.getElementById('in-reg-phone').value;
            if(!name || !phone) return;
            localStorage.setItem('user_name', name); localStorage.setItem('user_phone', phone);
            updateUI(); closeLoginModal(); saveData(phone, name);
        }
        function saveData(phone, name) {
            var service = document.getElementById('serviceType').value; var btn = document.querySelector('.submit-btn'); btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶™‡ßç‡¶≤‡ßá‡¶∏ ‡¶π‡¶ö‡ßç‡¶õ‡ßá...";
            var data = { name: name, phone: phone, landSize: finalArea, points: points, suggestion: aiSuggestion, serviceType: service };
            fetch(scriptURL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
            .then(() => { alert("‚úÖ ‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶∏‡¶´‡¶≤!"); resetMap(); btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®"; })
            .catch(err => { alert("‚ùå ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!"); btn.innerText = "‡¶Ö‡¶∞‡ßç‡¶°‡¶æ‡¶∞ ‡¶ï‡¶®‡¶´‡¶æ‡¶∞‡ßç‡¶Æ ‡¶ï‡¶∞‡ßÅ‡¶®"; });
        }

        // --- ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶á‡¶®‡¶ø‡¶∂‡¶ø‡ßü‡¶æ‡¶≤‡¶æ‡¶á‡¶ú‡ßá‡¶∂‡¶® ---
        window.onload = function() {
            updateUI();

            try {
                if (typeof L === 'undefined') {
                    alert("Leaflet ‡¶≤‡¶æ‡¶á‡¶¨‡ßç‡¶∞‡ßá‡¶∞‡¶ø ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø! ‡¶á‡¶®‡ßç‡¶ü‡¶æ‡¶∞‡¶®‡ßá‡¶ü ‡¶ö‡ßá‡¶ï ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
                    return;
                }

                map = L.map('map', { zoomControl: false }).setView([23.8103, 90.4125], 14);

                // üî• ‡ßß. ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™: OpenStreetMap (OSM) üî•
                // ‡¶è‡¶ü‡¶ø ‡ßß‡ß¶‡ß¶% ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶ï‡¶æ‡¶ú ‡¶ï‡¶∞‡¶¨‡ßá ‡¶ï‡¶æ‡¶∞‡¶£ ‡¶è‡¶ü‡¶ø GitHub ‡¶è ‡¶¨‡ßç‡¶≤‡¶ï ‡¶π‡ßü ‡¶®‡¶æ
                var osmLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);

                // ‡ß®. ‡¶Ö‡¶™‡¶∂‡¶®‡¶æ‡¶≤ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™: Google Satellite
                var googleSat = L.tileLayer('https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}', {
                    maxZoom: 20,
                    attribution: '¬© Google',
                    referrerPolicy: 'no-referrer'
                });

                // ‡¶≤‡ßá‡¶Ø‡¶º‡¶æ‡¶∞ ‡¶ï‡¶®‡ßç‡¶ü‡ßç‡¶∞‡ßã‡¶≤
                var baseMaps = {
                    "Normal Map (Safe)": osmLayer,
                    "Google Satellite": googleSat
                };
                L.control.layers(baseMaps).addTo(map);

                // ‡¶ú‡¶ø‡¶ì‡¶ï‡ßã‡¶°‡¶æ‡¶∞
                L.Control.geocoder({ defaultMarkGeocode: false, placeholder: "‡¶è‡¶≤‡¶æ‡¶ï‡¶æ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®...", collapsed: true })
                .on('markgeocode', function(e) {
                    var bbox = e.geocode.bbox;
                    var poly = L.polygon([bbox.getSouthEast(), bbox.getNorthEast(), bbox.getNorthWest(), bbox.getSouthWest()]);
                    map.fitBounds(poly.getBounds());
                }).addTo(map);

                map.on('locationfound', function(e) { document.querySelector('.gps-btn').style.background = 'white'; L.circle(e.latlng, { radius: 10, color: 'blue', fillOpacity: 0.2 }).addTo(map); });

                var storedData = localStorage.getItem('viewLand');
                if(storedData) {
                    var landPoints = JSON.parse(storedData);
                    showSavedLand(landPoints);
                    localStorage.removeItem('viewLand');
                }

                // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ (‡¶Ø‡¶æ‡¶§‡ßá ‡¶ó‡ßç‡¶∞‡ßá ‡¶∏‡ßç‡¶ï‡ßç‡¶∞‡¶ø‡¶® ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡ßá)
                setTimeout(function(){ map.invalidateSize(); }, 500);

            } catch(e) {
                alert("‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶è‡¶∞‡¶∞: " + e.message);
            }
        };

        function showSavedLand(savedPoints) {
            document.getElementById('start-btn-container').style.display = 'none';
            document.getElementById('dashboard-btn').style.display = 'none';
            document.getElementById('logout-btn').style.display = 'none';
            document.getElementById('back-btn').style.display = 'flex';
            var polygon = L.polygon(savedPoints, { color: '#39FF14', weight: 4, fillColor: '#39FF14', fillOpacity: 0.5 }).addTo(map);
            map.fitBounds(polygon.getBounds(), {padding: [50, 50]});
        }
    </script>
</body>
</html>
