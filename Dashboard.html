<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: 'Segoe UI', sans-serif; }
        .container { max-width: 400px; margin: 0 auto; }
        .box { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: center; }
        h2, h3 { color: #2E7D32; margin-bottom: 10px; }
        input { width: 100%; padding: 12px; margin: 15px 0; border: 2px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; text-align: center; }
        button { width: 100%; background: #4CAF50; color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; transition: 0.3s; }
        .hidden { display: none; }
        
        /* ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .record-card {
            background: #fff; padding: 15px; margin-top: 15px; 
            border-radius: 10px; border-left: 6px solid #4CAF50;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); text-align: left;
            position: relative; /* ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶®‡ßá‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø */
            cursor: pointer;
        }
        .record-card:active { background: #e8f5e9; }
        .status { display: inline-block; background: #e8f5e9; color: #2E7D32; padding: 3px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; margin-top: 5px; }

        /* ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶¨‡¶æ‡¶ü‡¶® ‡¶°‡¶ø‡¶ú‡¶æ‡¶á‡¶® */
        .delete-btn {
            position: absolute; top: 15px; right: 15px;
            background: #ff5252; color: white;
            width: 35px; height: 35px;
            border-radius: 50%; border: none;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 10;
        }
        .delete-btn:active { transform: scale(0.9); background: #d32f2f; }
    </style>
</head>
<body>
    <div class="container">
        <div id="login-section" class="box">
            <h2>‡¶ï‡ßÉ‡¶∑‡¶ï ‡¶°‡ßç‡¶Ø‡¶æ‡¶∂‡¶¨‡ßã‡¶∞‡ßç‡¶°</h2>
            <p style="color: #666;">‡¶Æ‡ßã‡¶¨‡¶æ‡¶á‡¶≤ ‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®:</p>
            <input type="tel" id="login-phone" placeholder="017xxxxxxxx">
            <button onclick="loginUser()">‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
        </div>

        <div id="dashboard-section" class="hidden">
            <div class="box">
                <h3>‡¶∏‡ßç‡¶¨‡¶æ‡¶ó‡¶§‡¶Æ, <span id="user-name">User</span>!</h3>
                <p>‡¶Æ‡ßã‡¶ü ‡¶ú‡¶Æ‡¶ø: <span id="total-land" style="font-weight:bold; color:#4CAF50">0</span> ‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</p>
                <button onclick="location.reload()" style="background: #ff5252; margin-top:10px;">‡¶≤‡¶ó‡¶Ü‡¶â‡¶ü</button>
            </div>
            <h4 style="margin-top:20px; color:#555;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ú‡¶Æ‡¶ø‡¶∏‡¶Æ‡ßÇ‡¶π:</h4>
            <div id="records-list"></div>
        </div>
    </div>

    <script>
        var scriptURL = "https://script.google.com/macros/s/AKfycbxPRbeqGFU_W-Ucx-www7Fn2v_6Q03wJ0IW_EUZvFmqYUBCf-N4OuzkHs_5vNSivrfg/exec"; 
        
        var globalRecords = [];
        var currentUserPhone = ""; // ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü‡ßá‡¶∞ ‡¶™‡¶∞ ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø

        function loginUser() {
            var phoneInput = document.getElementById('login-phone').value.trim();
            var btn = document.querySelector('button');

            if (!phoneInput) { alert("‡¶®‡¶æ‡¶Æ‡ßç‡¶¨‡¶æ‡¶∞ ‡¶¶‡¶ø‡¶®!"); return; }

            currentUserPhone = phoneInput; // ‡¶´‡ßã‡¶® ‡¶®‡¶Æ‡ßç‡¶¨‡¶∞ ‡¶∏‡ßá‡¶≠ ‡¶∞‡¶æ‡¶ñ‡¶æ
            btn.innerText = "‡¶ñ‡ßã‡¶Å‡¶ú‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá..."; btn.disabled = true;
            
            fetchDashboardData();
        }

        function fetchDashboardData() {
            fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                var userRecords = data.filter(item => {
                    var p = item.phone.toString();
                    return p == currentUserPhone || "0" + p == currentUserPhone || p == "0" + currentUserPhone; 
                });

                if (userRecords.length > 0) {
                    showDashboard(userRecords);
                } else {
                    alert("‡¶ï‡ßã‡¶®‡ßã ‡¶ú‡¶Æ‡¶ø ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø!");
                    document.querySelector('button').innerText = "‡¶§‡¶•‡ßç‡¶Ø ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®"; 
                    document.querySelector('button').disabled = false;
                    // ‡¶Ø‡¶¶‡¶ø ‡¶∏‡¶¨ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡ßá ‡¶´‡ßá‡¶≤‡ßá, ‡¶§‡¶æ‡¶π‡¶≤‡ßá ‡¶≤‡¶ó‡¶á‡¶® ‡¶™‡ßá‡¶ú‡ßá ‡¶™‡¶æ‡¶†‡¶æ‡¶¨‡ßã
                    document.getElementById('dashboard-section').classList.add('hidden');
                    document.getElementById('login-section').classList.remove('hidden');
                }
            })
            .catch(error => { alert("‡¶∏‡¶æ‡¶∞‡ßç‡¶≠‡¶æ‡¶∞ ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ!"); });
        }

        function showDashboard(records) {
            document.getElementById('login-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
            document.getElementById('user-name').innerText = records[0].name;
            
            globalRecords = records;
            var listHTML = "";
            var totalLand = 0;

            records.forEach(function(record, index) {
                var date = new Date(record.date).toLocaleDateString('bn-BD');
                totalLand += parseFloat(record.landSize);

                listHTML += `
                    <div class="record-card" onclick="openMap(${index})">
                        
                        <button class="delete-btn" onclick="deleteRecord(event, ${index})">
                            <i class="fas fa-trash"></i>
                        </button>

                        <div style="font-size: 18px; font-weight: bold;">üå± ${record.landSize} ‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂ ‡¶ú‡¶Æ‡¶ø</div>
                        <div style="color: gray; font-size: 14px; margin: 5px 0;">üìÖ ‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ: ${date}</div>
                        <div class="status">‚óè ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™‡ßá ‡¶¶‡ßá‡¶ñ‡ßÅ‡¶® üó∫Ô∏è</div>
                    </div>
                `;
            });

            document.getElementById('records-list').innerHTML = listHTML;
            document.getElementById('total-land').innerText = totalLand.toFixed(2);
        }

        function openMap(index) {
            var selectedRecord = globalRecords[index];
            if(selectedRecord.points) {
                localStorage.setItem('viewLand', selectedRecord.points);
                window.location.href = 'index.html';
            } else {
                alert("‡¶¶‡ßÅ‡¶É‡¶ñ‡¶ø‡¶§, ‡¶è‡¶ü‡¶ø ‡¶è‡¶ï‡¶ü‡¶ø ‡¶™‡ßÅ‡¶∞‡¶æ‡¶§‡¶® ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°‡•§ ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶®‡ßá‡¶á‡•§");
            }
        }

        // üî• ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶´‡¶æ‡¶Ç‡¶∂‡¶® üî•
        function deleteRecord(event, index) {
            event.stopPropagation(); // ‡¶Æ‡ßç‡¶Ø‡¶æ‡¶™ ‡¶ì‡¶™‡ßá‡¶® ‡¶π‡¶ì‡ßü‡¶æ ‡¶Ü‡¶ü‡¶ï‡¶æ‡¶¨‡ßá
            
            if(!confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶è‡¶á ‡¶ú‡¶Æ‡¶ø‡¶ü‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) return;

            var record = globalRecords[index];
            var btn = event.target.closest('button'); // ‡¶Ø‡ßá ‡¶¨‡¶æ‡¶ü‡¶®‡ßá ‡¶ö‡¶æ‡¶™ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // ‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶Ü‡¶á‡¶ï‡¶®

            // ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶∞‡¶ø‡¶ï‡ßã‡ßü‡ßá‡¶∏‡ßç‡¶ü ‡¶™‡¶æ‡¶†‡¶æ‡¶®‡ßã
            var data = { 
                action: "delete", 
                phone: record.phone, 
                landSize: record.landSize 
            };

            fetch(scriptURL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                alert("‚úÖ ‡¶ú‡¶Æ‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                // ‡¶™‡ßá‡¶ú ‡¶∞‡¶ø‡¶´‡ßç‡¶∞‡ßá‡¶∂ ‡¶®‡¶æ ‡¶ï‡¶∞‡ßá ‡¶Ü‡¶¨‡¶æ‡¶∞ ‡¶°‡¶æ‡¶ü‡¶æ ‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
                fetchDashboardData();
            })
            .catch(err => {
                alert("‚ùå ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá!");
                btn.innerHTML = '<i class="fas fa-trash"></i>';
            });
        }
    </script>
</body>
</html>
